<!DOCTYPE html>
<html lang="en">
<head>
    <title>Readme</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="media/css/restdown.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
</head>
<body>
<div id="header">
    <h1>Readme Documentation</h1>
</div>

    <div id="sidebar">
<ul>
  <li><div><a href="#smartdatacenter-tree">SmartDataCenter Tree</a></div>
  <ul>
    <li><div><a href="#Tree"><span class="method name"><span class="name">Tree</span></span></a></div></li>
    <li><div><a href="#Entries/Schema"><span class="method name"><span class="name">Entries/Schema</span></span></a></div></li>
  </ul></li>
  <li><div><a href="#how-stuff-works">How Stuff works</a></div>
  <ul>
    <li><div><a href="#Schema"><span class="method name"><span class="name">Schema</span></span></a></div></li>
    <li><div><a href="#Indexing"><span class="method name"><span class="name">Indexing</span></span></a></div></li>
    <li><div><a href="#Adding-Triggers"><span class="method name"><span class="name">Adding Triggers</span></span></a></div></li>
    <li><div><a href="#Searching-(effectively)"><span class="method name"><span class="name">Searching (effectively)</span></span></a></div></li>
    <li><div><a href="#Changelog"><span class="method name"><span class="name">Changelog</span></span></a></div></li>
  </ul></li>
  <li><div><a href="#developmentsetup">Development/Setup</a></div>
  <ul>
    <li><div><a href="#Erlang"><span class="method name"><span class="name">Erlang</span></span></a></div></li>
    <li><div><a href="#Riak"><span class="method name"><span class="name">Riak</span></span></a></div></li>
    <li><div><a href="#UFDS"><span class="method name"><span class="name">UFDS</span></span></a></div></li>
    <li><div><a href="#CAPI"><span class="method name"><span class="name">CAPI</span></span></a></div></li>
  </ul></li>
  <li><div><a href="#todo">TODO</a></div></li>
</ul>

    </div>
    <div id="content">
<!-- -*- mode: markdown -*- -->


<h1>Overview</h1>
<div class="intro">


<p>UFDS is the "unified foundational directory service" built for SDC over
<a href="http://ldapjs.org">ldapjs</a> and <a href="http://mcavage.github.com/node-ldapjs-riak">Riak</a>,
and is used to track accounts, credentials, and more. It is a superset of
functionality offered by previous SDC versions employing CAPI (there is a
backwards compatible "shim" that offers the same API as CAPI did in SDC 6.5).</p>

<p>This document does not really discuss any generic-LDAP things, but
really just the SDC-specific uses of it.</p>


</div>
<h1 id="smartdatacenter-tree">SmartDataCenter Tree</h1>

<h2 id="Tree"><span class="method name"><span class="name">Tree</span></span></h2>

<p>The directory tree is laid out as follows:</p>

<pre><code>o=smartdc
  +-ou=customers
  |  +-uuid=:uuid
  |  | +-key=:fingerpring
  |  | +-metadata=:appkey
  |  | +-dclimit=:datacenter
  +-ou=operators
  |  +-uuid=:uuid
  |  | +-key=:fingerpring
  |  | +-metadata=:appkey
  |  | +-dclimit=:datacenter
</code></pre>

<p>So, basically there are two "subtrees", one for customers and one for
operators.  We could maintain a static group of operators in the tree,
rather than separating it out.  However, then there is a burden to
keep the tree and that group in sync (since "dynamic" LDAP groups are
not yet supported).  But it's probably a better long-term approach.</p>

<h2 id="Entries/Schema"><span class="method name"><span class="name">Entries/Schema</span></span></h2>

<p>Reference the files in <code>./schema</code> for an up to date list of attributes
et al. This is just high-level information on what you can look for.</p>

<h3>sdcPerson</h3>

<p>The <code>sdcPerson</code> type is one of the <code>uuid=:uuid, ou=customers, o=smartdc</code>
entries (or operators), and contains all the attributes for a "user".
These objects should always be stored by uuid.  Here's the
bootstrapped user:</p>

<pre><code>dn: uuid=930896af-bf8c-48d4-885c-6573a94b1853, ou=operators, o=smartdc
cn: Admin
email: user@joyent.com
login: admin
objectclass: sdcperson
sn: User
uuid: 930896af-bf8c-48d4-885c-6573a94b1853
</code></pre>

<h3>sdcKey</h3>

<p>The <code>sdcKey</code> objectclass holds SSH keys for tenants, as well as the
OpenSSL compatible form of the SSH key (to support signing).  While
these objects have a <code>name</code> field, they are stored by fingerprint, and
it is on the short term TODO list to make CloudAPI work with
fingerprint as the URL.</p>

<h3>CAPI Specific Objects</h3>

<p>Unclear if these have long-term viability, but for now they exist,
so...</p>

<h4>capiLimit</h4>

<p>Holds a mapping of "limits" per dataset type in a particular
datacenter.  Stored with "dclimit=:datacenter, ..." as the DN.</p>

<h4>capiMetadata</h4>

<p>There's probably not anything using this, but it's just a free-form
entry (meaning you can put any attribute/value pairs in you
want). Stored by <code>metadata=:appkey, ...</code>.</p>

<h1 id="how-stuff-works">How Stuff works</h1>

<h2 id="Schema"><span class="method name"><span class="name">Schema</span></span></h2>

<p>Schema for UFDS is built on a custom framework where you extend a
<code>Validator</code> class, and simply model the attributes you want, whether
they're required or optional, and the number of values to allow.  This
means to add new schema types into UFDS, you have to write (minimal)
code.  Take a look at <code>./schema</code> to get a feel for what this looks
like.  It's really not rocket science.</p>

<p>The schema framework automatically runs on add/modify/modifyDN, and
UFDS "discovers" all schema in that directory, so all you need to do
to get a new type in the system is drop a file in there.</p>

<p>In terms of the paradigm, you describe your <em>required</em> attributes, and
the number of values each can have, and then decide whether or not you
want the type to be <em>strict</em>.  Strict set to true means that only the
attributes described in your schema will be allowed, and you can then
use the <em>optional</em> block to describe optional attributes.  If <em>strict</em>
is false, then <em>optional</em> is pretty much irrelevant, as anything
goes (<em>required</em> attributes however, must be present). The default for
strictness is <em>false</em>.</p>

<h2 id="Indexing"><span class="method name"><span class="name">Indexing</span></span></h2>

<p>UFDS supports indexes and unique indexes.  Indexes are fairly cheap, so it's
advantageous to index a lot of fields, really.  Unique indexes however, are
extremely costly, so we only really want to set those where you really
need them (notably login and email, since we're assuming we can generate
uuid's without collision).</p>

<p>Indexing is configured in config.json, and leverages Riak's <code>2i</code>
code.  Note that you'll need to keep <code>./cfg/config.json.in</code> in sync
with what's needed, as that's what usb-headnode uses to generate the
"in zone" config.  But in the config file, you'll see this block:</p>

<pre><code>"indexes": {
  "login": true,
  "email": true,
  "uuid": true,
  "fingerprint": false,
  "_owner": false,
  "company": false,
  "postalcode": false,
  "country": false,
  "city": false,
  "state": false,
  "cn": false,
  "sn": false
}
</code></pre>

<p><em>true</em> means the attribute is a unique index, <em>false</em> means it's a
regular index.  Everything in there ends up as a Riak 2i index.</p>

<p>Note that there's no such thing as "reindexing" in Riak, so if you
need indexes for your types, you <em>must</em> put them in before customer's
touch the release (i.e., before any real data ends up in the
stack). Reindexing means you've got to dump and reload.  Not pretty.</p>

<h2 id="Adding-Triggers"><span class="method name"><span class="name">Adding Triggers</span></span></h2>

<p>Most of the code for UFDS is really in the <a href="ldapjs">http://ldapjs.org</a>
and <a href="ldapjs-riak">http://mcavage.github.com/node-ldapjs-riak</a>
code-bases, but the SmartDataCenter specific stuff lives here.  For
example, to allow easy migration from CAPI to UFDS, password salting
is <em>identical</em> to CAPI's. To do that, there's a <code>./lib/salt.js</code> file
that has ldapjs handlers that inject attributes and modify the request
as appropriate for each LDAP operation type that's appropriate.
Similarly, there's code to convert an SSH key into the PKCS#8 PEM
format.</p>

<p>Basically, if you want UFDS to do something other than store your
record as-is, you need to write code to do so, and add it into the
handler chain as appropriate.</p>

<h2 id="Searching-(effectively)"><span class="method name"><span class="name">Searching (effectively)</span></span></h2>

<p>This is really important, so read this 2x if you have to! If you're
doing searches on Riak that are <em>not</em> indexed, you're fucked. Stop. Go
back and figure out how to find what you need with indexes.</p>

<p>To find a customer from the top of the tree, you're best off doing
something like <code>(&amp;(login=markc)(objectclass=sdcperson))</code> or
<code>(&amp;(email=mark.cavage@joyent.com)(objectclass=sdcperson))</code>.  That's
going to find you a record where you can then use the DN.  So, suppose
I found one where the DN was
<code>uuid=930896af-bf8c-48d4-885c-6573a94b1853, ou=operators,
o=smartdc</code>. I could then go ahead and (safely) use <em>any</em> filter if I
retarget searches at that scope base.  This is because UFDS
automatically indexes all objects at or under a <code>uuid=...</code> entry with
the <code>_owner</code> attribute, and on searches will automagically add that
<code>_owner=$uuid</code> into your search filter.</p>

<p>So, once you're searching at or under a customer record, do whatever
you want. When searching from the top of the tree, only use equality
filters on indexed attributes (you can use an <code>and</code> filter, but one of
them really should be an equality match).</p>

<h3>Hidden attributes</h3>

<p>UFDS stores a bunch of attributes prefixed with <code>_</code>.  For example,
<code>_ctime</code>, <code>_salt</code>, etc.  And, by default, UFDS will not return these
on searches (notably this includes <code>userpassword</code>).  To make UFDS
return these, you must (1) be an operator (or the actual admin), and
(2) you must pass in the "hiddenAttributes" control, which is
something Joyent invented.  The OID for this control is
'1.3.6.1.4.1.38678.1'. Here's an example search that shows all the attributes:</p>

<pre class="shell"><code>./bin/ldapjs-search -u ldaps://10.99.99.21 -D cn=root -w secret -c 1.3.6.1.4.1.38678.1 -b o=smartdc "(login=*)"
[{
  "dn": "uuid=930896af-bf8c-48d4-885c-6573a94b1853, ou=operators, o=smartdc",
  "cn": "Admin",
  "email": "user@joyent.com",
  "login": "admin",
  "objectclass": "sdcperson",
  "sn": "User",
  "userpassword": "d72f926f632784be67d1f96a4d82396c67ef5f5b",
  "uuid": "930896af-bf8c-48d4-885c-6573a94b1853",
  "_salt": "51bcac43c05e9148744b151317351fd96d8d953f",
  "_owner": "930896af-bf8c-48d4-885c-6573a94b1853",
  "_ctime": "2011-10-25T16:45:08Z",
  "_createdfrom": "undefined:undefined::5",
  "_createdby": "cn=root",
  "_mtime": "2011-10-25T16:45:08Z",
  "_modifiedfrom": "undefined:undefined::5",
  "_modifiedby": "cn=root"
}]
</code></pre>

<h2 id="Changelog"><span class="method name"><span class="name">Changelog</span></span></h2>

<p>UFDS supports an almost-RFC compliant LDAP changelog, which will
always live at <code>cn=changelog</code>.  It contains all changes that have ever
happened in the directory.  You can search by <code>changetype</code>,
<code>changenumber</code>, <code>changetime</code> and <code>targetdn</code>.  Here's a sample record:</p>

<pre><code>dn: changenumber=1319561108253, cn=changelog
targetdn: uuid=930896af-bf8c-48d4-885c-6573a94b1853, ou=operators, o=smartdc
changetime: 2011-10-25T16:45:08Z
changenumber: 1319561108253
changetype: add
changes: {"cn":["Admin"],"email":["user@joyent.com"],"login":["admin"],"object
 class":["sdcPerson"],"sn":["User"],"userpassword":"XXXXXX","uuid":["930896af-
 bf8c-48d4-885c-6573a94b1853"],"_salt":["51bcac43c05e9148744b151317351fd96d8d9
 53f"],"_owner":["930896af-bf8c-48d4-885c-6573a94b1853"]}
objectclass: changeLogEntry
</code></pre>

<h1 id="developmentsetup">Development/Setup</h1>

<p>This all assumes you're developing for UFDS on your macbook.</p>

<h2 id="Erlang"><span class="method name"><span class="name">Erlang</span></span></h2>

<pre class="shell"><code>brew install erlang
</code></pre>

<h2 id="Riak"><span class="method name"><span class="name">Riak</span></span></h2>

<p>You need a 1.0.x version of Riak. Get one here:
<a href="http://downloads.basho.com/riak/riak-1.0.1">http://downloads.basho.com/riak/riak-1.0.1</a>.</p>

<p>Once you have that, you need to be on the leveldb backend, so crack open
<code>riak-1.0.0rc1/etc/app.config</code> and under the section <code>{riak_kv</code>, change the
key <code>storage_backend</code> to <code>riak_kv_eleveldb_backend</code> (it will probably be set
to bitcask).  Once you have that, you also need to increase your ulimits:
<code>ulimit -n 2048</code>, and I just run from a local shell: <code>./bin/riak start</code>. If you
want to clean out/reset your data:
<code>./bin/riak stop &amp;&amp; rm -fr data/leveldb/* &amp;&amp; ./bin/riak start</code></p>

<h2 id="UFDS"><span class="method name"><span class="name">UFDS</span></span></h2>

<p>Next you need to start UFDS, which is the LDAP interface over riak.  Config
for this is stored in <code>./cfg/config.json</code>, but assuming you're running localhost
riak, you should be good to go with: <code>node main.js -f cfg/config.json -d 2</code>;
note the <code>-d 2</code> is optional, but will spew diagnostic logs for you, which is
helpful if you're developing.</p>

<h3>Aliasing the OpenLDAP CLI</h3>

<p>Do this, or your life will suck:</p>

<pre class="shell"><code>alias lsearch='LDAPTLS_REQCERT=allow ldapsearch -x -LLL -D cn=root -w secret -H ldaps://localhost:1636'
$ alias ladd='LDAPTLS_REQCERT=allow ldapadd -x -D cn=root -w secret -H ldaps://localhost:1636'
$ alias lmodify='LDAPTLS_REQCERT=allow ldapmodify -x -D cn=root -w secret -H ldaps://localhost:1636'
$ alias ldelete='LDAPTLS_REQCERT=allow ldapdelete -x -D cn=root -w secret -H ldaps://localhost:1636'
</code></pre>

<h3>Bootstrapping</h3>

<p>Once you have riak+ufds running, you need to 'bootstrap' the LDAP tree.</p>

<pre class="shell"><code>ladd -f ./data/bootstrap.ldif
</code></pre>

<p>That adds the shell of the tree, as well as the "admin" user.  To add
a bunch of new records, you can run:</p>

<pre class="shell"><code>ladd -f ./data/1k.ldif
</code></pre>

<p>Also, in <code>./tools</code> is <code>genldif</code>, which you can invoke like:</p>

<pre class="shell"><code>./tools/genldif -k -n 10000
</code></pre>

<p>To generate 10k users with SSH keys (note they will all share one SSH key).</p>

<h2 id="CAPI"><span class="method name"><span class="name">CAPI</span></span></h2>

<p>To maintain backwards compatibility, there is a restify app that "approximates"
the old CAPI interface. It assumes that UFDS is running on the same host, so to
fire it up, just run <code>node capi.js -u ldaps://localhost:1636 -p 8080 -d 2</code>.</p>

<p>To make curl'ing the CAPI thing easier, I have a small bash function:</p>

<pre><code>function capi() {
    /usr/bin/curl -is -H 'Accept: application/json' -H 'content-type: application/xml' -u admin:tot@ls3crit --url http://localhost:8080$@ ;
    echo "";
}
</code></pre>

<p>After that, reference the CAPI api at <a href="http://apidocs.joyent.com/sdcapidoc/capi">http://apidocs.joyent.com/sdcapidoc/capi</a>.</p>

<p>But, here's some helpers for you:</p>

<h3>Customers</h3>

<p>||<em>create</em>||<code>capi /customers -d @/Users/mark/work/ufds/data/capi_customer.xml</code>||
||<em>update</em>||<code>capi /customers/03afb9ac-925c-4e39-9ec2-ddbb2df9ef7d -d @/Users/mark/work/ufds/data/update_customer.xml -X PUT</code>||
||<em>get</em>||<code>capi /customers/03afb9ac-925c-4e39-9ec2-ddbb2df9ef7d</code>||
||<em>list</em>||<code>capi /customers</code>||
||<em>search</em>||<code>capi /customers?email_address=%40joyent.com</code>||
||<em>delete</em>||<code>capi /customers/03afb9ac-925c-4e39-9ec2-ddbb2df9ef7d -X DELETE</code>||</p>

<h3>SSH keys</h3>

<p>||<em>add</em>||<code>/usr/bin/curl -is http://localhost:8080/customers/03afb9ac-925c-4e39-9ec2-ddbb2df9ef7d/keys --data-urlencode key@/Users/mark/.ssh/id_rsa.pub -d name=id_rsa</code>||
||<em>list</em>||<code>capi /customers/9c664a75-b638-4bc6-9213-9cda22f8f2d9/keys</code>||
||<em>rename</em>||<code>capi /customers/9c664a75-b638-4bc6-9213-9cda22f8f2d9/keys/7bc05cd69e110c76044b03c911f2727f?name=foo -X PUT</code>||
||<em>delete</em>||<code>capi /customers/9c664a75-b638-4bc6-9213-9cda22f8f2d9/keys/7bc05cd69e110c76044b03c911f2727f -X DELETE</code>||</p>

<h1 id="todo">TODO</h1>

<ul>
<li>load balancing Riak cluster</li>
<li>JSON error messages</li>
<li>port CloudAPI/Portal</li>
<li>change numbers as uuid</li>
<li>6.5 upgrade</li>
<li>CloudAPI to use fingerprints instead of names</li>
</ul>

    </div>
<script type="text/javascript" charset="utf-8">
$(function() {
    var headerHeight = $("#header").height();

    var sections = $("#content h1[id], #content h2[id]");
    var sectionOffsets = [];
    var slack = 100;  // Give the section scroll some slack (in pixels).
    sections.each(function(elem) {
        sectionOffsets.push($(this).offset().top - headerHeight - slack);
    });

    var currSectionIdx = -1;
    function getSectionIdx(scrollDistance) {
        if (scrollDistance < sectionOffsets[0]) {
            return -1;
        } else {
            for (var id = sectionOffsets.length; id > 0; id--) {
                if (scrollDistance > sectionOffsets[id - 1]) {
                    return id - 1;
                    break;
                }
            }
        }
    }

    /** {{{ http://code.activestate.com/recipes/577787/ (r2) */
    _slugify_strip_re = /[^\w\s-]/g;
    _slugify_hyphenate_re = /[-\s]+/g;
    function slugify(s) {
      s = s.replace(_slugify_strip_re, '').trim().toLowerCase();
      s = s.replace(_slugify_hyphenate_re, '-');
      return s;
    }
    /** end of http://code.activestate.com/recipes/577787/ }}} */


    $("#content").scroll(function() {
        var scrollDistance = $("#content").attr('scrollTop');
        var sectionIdx = getSectionIdx(scrollDistance);
    
        if (sectionIdx !== currSectionIdx) {
            $("#sidebar li>div").removeClass("current");
            currSectionIdx = sectionIdx;
            if (currSectionIdx >= 0) {
                var heading = $(sections[currSectionIdx]).text();
                var possibleAnchors = [
                    slugify(heading), // h1 or non-method h2
                    heading.replace(/ /g, '-'), // h2 method, just name or just endpoint
                    heading.slice(0, heading.lastIndexOf(' (')).trimRight().replace(/ /g, '-'), // h2 method, name and endpoint
                ]
                for (var i=0; i < possibleAnchors.length; i++) {
                    $("#sidebar a[href|=#" + possibleAnchors[i] + "]").parent().addClass("current");
                }
            }
        }
    });
});
</script>

</body>
</html>
